#!/usr/bin/env ruby
require 'json'

workflow_id = ARGV[0]
puts ARGV.inspect
nero_config = JSON.parse(File.read(ARGV[1]))

while line = STDIN.gets
  event = JSON.parse(line)

  if event["source"] == "panoptes" && event["type"] == "classification"
    workflows = event["linked"]["workflows"].map do |workflow|
      if workflow["id"] == workflow_id
        workflow.merge("nero_config" => nero_config)
      else
        workflow
      end
    end

    event["linked"]["workflows"] = workflows
  end

  puts JSON.dump(event)
end
